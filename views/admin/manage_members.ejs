<%- include('../partials/header', { title: 'Quản lý Thành viên', user:
loggedInUser }) %> <%- include('../partials/navbar', { user: loggedInUser }) %>

<div class="members-container">
  <h1 class="page-title">Danh sách Thành viên (Collectors)</h1>

  <% if (success && success.length > 0) { %>
  <div class="alert alert-success">
    <span><%= success[0] %></span>
  </div>
  <% } %> <% if (error && error.length > 0) { %>
  <div class="alert alert-error">
    <span><%= error[0] %></span>
  </div>
  <% } %> <% if (member && member.isAdmin) { %>
  <button id="openModalBtn" class="btn btn-secondary">
    + Thêm tài khoản Admin mới
  </button>

  <div id="addMemberModal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">Thêm Tài Khoản Admin Mới</h2>

      <form
        id="addMemberForm"
        method="POST"
        action="/auth/admin"
        class="form-grid"
      >
        <div class="form-group full">
          <label for="email">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder="Nhập email"
            required
          />
        </div>

        <div class="form-group full">
          <label for="name">Tên Admin</label>
          <input
            type="text"
            id="name"
            name="name"
            placeholder="Nhập tên"
            required
          />
        </div>

        <div class="form-group">
          <label for="password">Mật khẩu</label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Đặt mật khẩu"
            required
          />
        </div>

        <div class="form-group">
          <label>Role</label>
          <input type="text" value="Admin" disabled class="readonly" />
          <input type="hidden" name="isAdmin" value="true" />
        </div>

        <div class="modal-actions full">
          <button type="button" id="closeModalBtn" class="btn btn-light">
            Hủy
          </button>
          <button type="submit" class="btn btn-secondary">Tạo Admin</button>
        </div>
      </form>
    </div>
  </div>
  <% } %>

  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Email</th>
          <th>Tên</th>
          <th>Role</th>
          <th>Ngày đăng ký</th>
        </tr>
      </thead>
      <tbody>
        <% members.forEach((memberItem, index) => { %>
        <tr>
          <td><%= index + 1 %></td>
          <td><%= memberItem.email %></td>
          <td><%= memberItem.name %></td>
          <td class="border px-4 py-2">
            <span
              class="badge <%= memberItem.isAdmin ? 'badge-admin' : 'badge-member' %>"
            >
              <%= memberItem.isAdmin ? 'Admin' : 'Member' %>
            </span>
          </td>
          <td>
            <%= new Date(memberItem.createdAt).toLocaleDateString('vi-VN') %>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <% if (totalPages > 1) { %>
  <div class="pagination">
    <% for (let i = 1; i <= totalPages; i++) { %>
    <a
      href="/admin/manage_members?page=<%= i %>"
      class="page-link <%= i === currentPage ? 'active' : '' %>"
    >
      <%= i %>
    </a>
    <% } %>
  </div>
  <% } %>

  <div class="alert alert-info">
    <span>
      Chỉ <b>Admin</b> mới có thể thêm thành viên. Ordinary members không được
      thao tác.
    </span>
  </div>
</div>

<%- include('../partials/footer') %>

<script>
  const modal = document.getElementById("addMemberModal");
  const openBtn = document.getElementById("openModalBtn");
  const closeBtn = document.getElementById("closeModalBtn");

  if (openBtn && modal && closeBtn) {
    openBtn.addEventListener("click", () => modal.classList.add("show"));
    closeBtn.addEventListener("click", () => modal.classList.remove("show"));
    modal.addEventListener("click", (e) => {
      if (e.target === modal) modal.classList.remove("show");
    });
  }
</script>
