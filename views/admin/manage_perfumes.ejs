<%- include('../partials/header', { title: 'Quản lý Nước hoa', user:
loggedInUser }) %> <%- include('../partials/navbar', { user: loggedInUser }) %>

<div class="container">
  <h1 class="page-title">Quản lý Nước hoa (Perfumes)</h1>

  <div class="top-bar">
    <span class="count"
      >Tổng số: <strong><%= perfumes.length %></strong> sản phẩm</span
    >
    <button
      class="btn btn-secondary"
      onclick="document.getElementById('add_perfume_modal').showModal()"
    >
      ➕ Thêm Nước hoa Mới
    </button>
  </div>

  <% if (message) { %>
  <div
    class="alert <%= message.type === 'success' ? 'alert-success' : 'alert-error' %>"
  >
    <%= message.text %>
  </div>
  <% } %>

  <div class="table-wrapper">
    <table class="perfume-table">
      <thead>
        <tr>
          <th>STT</th>
          <th>Ảnh</th>
          <th>Tên Nước hoa</th>
          <th>Giá</th>
          <th>Brand</th>
          <th>Concentration</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <% perfumes.forEach((perfume, index) => { %>
        <tr>
          <td><%= index + 1 %></td>
          <td>
            <img
              src="<%= perfume.uri %>"
              alt="<%= perfume.perfumeName %>"
              class="thumb"
            />
          </td>
          <td><strong><%= perfume.perfumeName %></strong></td>
          <td><%= perfume.price.toLocaleString('vi-VN') %> VNĐ</td>
          <td><%= perfume.brand.brandName %></td>
          <td>
            <span
              class="badge <%= perfume.concentration === 'Extrait' ? 'badge-warning' : 'badge-info' %>"
            >
              <%= perfume.concentration %>
            </span>
          </td>
          <td>
            <button
              class="btn btn-warning btn-xs"
              onclick="editPerfume('<%= JSON.stringify(perfume) %>')"
            >
              Sửa
            </button>
            <form
              action="/admin/perfumes/<%= perfume._id %>?_method=DELETE"
              method="POST"
              class="inline-form"
              onsubmit="return confirm('Xác nhận xóa nước hoa <%= perfume.perfumeName %>?');"
            >
              <button type="submit" class="btn btn-error btn-xs">Xóa</button>
            </form>
          </td>
        </tr>
        <% }) %> <% if (perfumes.length === 0) { %>
        <tr>
          <td colspan="7" class="text-center text-muted">
            Chưa có nước hoa nào được tạo.
          </td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- MODAL ADD PERFUME -->
<dialog id="add_perfume_modal" class="modal">
  <div class="modal-box">
    <h3 class="modal-title">Thêm Nước hoa Mới</h3>
    <form
      action="/admin/perfumes"
      method="POST"
      enctype="multipart/form-data"
      class="form-grid"
    >
      <div class="form-group">
        <label>Tên Nước hoa</label>
        <input type="text" name="perfumeName" required />
      </div>

      <div class="form-group">
        <label>Thương hiệu</label>
        <select name="brandId" required>
          <option value="">Chọn Thương hiệu</option>
          <% brands.forEach(brand => { %>
          <option value="<%= brand._id %>"><%= brand.brandName %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-group">
        <label>Giá (VNĐ)</label>
        <input type="number" name="price" min="0" required />
      </div>

      <div class="form-group">
        <label>Dung tích (ml)</label>
        <input type="number" name="volume" min="1" required />
      </div>

      <div class="form-group">
        <label>Đối tượng</label>
        <select name="targetAudience" required>
          <option value="">Chọn</option>
          <option value="male">Nam</option>
          <option value="female">Nữ</option>
          <option value="unisex">Unisex</option>
        </select>
      </div>

      <div class="form-group">
        <label>Nồng độ</label>
        <select name="concentration" required>
          <option value="">Chọn</option>
          <option value="Extrait">Extrait</option>
          <option value="EDP">EDP</option>
          <option value="EDT">EDT</option>
          <option value="EDC">EDC</option>
        </select>
      </div>

      <div class="form-group full">
        <label>Ảnh sản phẩm</label>
        <input type="file" name="image" accept="image/*" required />
      </div>

      <div class="form-group full">
        <label>Mô tả</label>
        <textarea name="description" required></textarea>
      </div>

      <div class="form-group full">
        <label>Thành phần</label>
        <textarea name="ingredients" required></textarea>
      </div>

      <div class="modal-actions">
        <button type="submit" class="btn btn-secondary">Thêm</button>
        <button
          type="button"
          class="btn btn-light"
          onclick="add_perfume_modal.close()"
        >
          Hủy
        </button>
      </div>
    </form>
  </div>
</dialog>

<!-- MODAL EDIT PERFUME -->
<dialog id="edit_perfume_modal" class="modal">
  <div class="modal-box">
    <h3 class="modal-title warning">Chỉnh sửa Nước hoa</h3>
    <form id="editPerfumeForm" method="POST">
      <input type="hidden" name="_method" value="PUT" />

      <div class="form-grid">
        <div class="form-group full">
          <label>Tên</label>
          <input id="editPerfumeName" name="perfumeName" required />
        </div>
        <div class="form-group">
          <label>Giá</label>
          <input id="editPrice" name="price" required />
        </div>
        <div class="form-group">
          <label>Dung tích</label>
          <input id="editVolume" name="volume" required />
        </div>
        <div class="form-group">
          <label>Thương hiệu</label>
          <select id="editBrandId" name="brandId">
            <% brands.forEach(brand => { %>
            <option value="<%= brand._id %>"><%= brand.brandName %></option>
            <% }) %>
          </select>
        </div>
        <div class="form-group full">
          <label>URL Ảnh</label>
          <input id="editUri" name="uri" required />
        </div>
        <div class="form-group full">
          <label>Mô tả</label>
          <textarea id="editDescription" name="description"></textarea>
        </div>
        <div class="form-group full">
          <label>Thành phần</label>
          <textarea id="editIngredients" name="ingredients"></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button type="submit" class="btn btn-warning">Cập nhật</button>
        <button
          type="button"
          class="btn btn-light"
          onclick="edit_perfume_modal.close()"
        >
          Hủy
        </button>
      </div>
    </form>
  </div>
</dialog>

<script>
  function editPerfume(perfumeJson) {
    const perfume = JSON.parse(perfumeJson.replace(/&quot;/g, '"'));
    const form = document.getElementById("editPerfumeForm");
    form.action = `/admin/perfumes/${perfume._id}?_method=PUT`;

    document.getElementById("editPerfumeName").value = perfume.perfumeName;
    document.getElementById("editPrice").value = perfume.price;
    document.getElementById("editVolume").value = perfume.volume;
    document.getElementById("editUri").value = perfume.uri;
    document.getElementById("editDescription").value = perfume.description;
    document.getElementById("editIngredients").value = perfume.ingredients;
    document.getElementById("editBrandId").value =
      perfume.brand._id || perfume.brand;
    edit_perfume_modal.showModal();
  }
</script>

<%- include('../partials/footer') %>
