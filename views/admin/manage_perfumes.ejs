<%- include('../partials/header', { title: 'Quản lý Nước hoa', user:
loggedInUser }) %> <%- include('../partials/navbar', { user: loggedInUser }) %>

<div class="container">
  <h1 class="page-title">Quản lý Nước hoa (Perfumes)</h1>

  <div class="top-bar">
    <span class="count">
      Tổng số: <strong><%= perfumes.length %></strong> sản phẩm
    </span>

    <button
      class="btn btn-secondary"
      onclick="document.getElementById('add_perfume_modal').showModal()"
    >
      ➕ Thêm Nước hoa Mới
    </button>
  </div>

  <% if (success && success.length > 0) { %>
  <div class="alert alert-success">
    <span><%= success[0] %></span>
  </div>
  <% } %> <% if (error && error.length > 0) { %>
  <div class="alert alert-error">
    <span><%= error[0] %></span>
  </div>
  <% } %>

  <div class="table-wrapper">
    <table class="perfume-table">
      <thead>
        <tr>
          <th>STT</th>
          <th>Ảnh</th>
          <th>Tên Nước hoa</th>
          <th>Giá</th>
          <th>Brand</th>
          <th>Concentration</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <% if (perfumes.length === 0) { %>
        <tr>
          <td colspan="7" class="text-center text-muted">
            Chưa có nước hoa nào được tạo.
          </td>
        </tr>
        <% } else { %> <% perfumes.forEach((perfume, index) => { %>
        <tr>
          <td><%= index + 1 %></td>
          <td>
            <img
              src="<%= perfume.uri %>"
              alt="<%= perfume.perfumeName %>"
              class="thumb"
            />
          </td>
          <td><strong><%= perfume.perfumeName %></strong></td>
          <td><%= perfume.price.toLocaleString('vi-VN') %> VNĐ</td>
          <td><%= perfume.brand.brandName %></td>
          <td>
            <span
              class="badge <%= perfume.concentration === 'Extrait' ? 'badge-warning' : 'badge-info' %>"
            >
              <%= perfume.concentration %>
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button
                class="btn btn-warning btn-xs"
                onclick="editPerfume('<%= JSON.stringify(perfume) %>')"
              >
                Sửa
              </button>

              <form
                action="/admin/perfumes/<%= perfume._id %>?_method=DELETE"
                method="POST"
                class="inline-form"
                onsubmit="return confirm('Xác nhận xóa nước hoa <%= perfume.perfumeName %>?');"
              >
                <button type="submit" class="btn btn-error btn-xs">Xóa</button>
              </form>
            </div>
          </td>
        </tr>
        <% }) %> <% } %>
      </tbody>
    </table>

    <% if (totalPages > 1) { %>
    <div class="pagination flex justify-center gap-2 mt-6">
      <% for (let i = 1; i <= totalPages; i++) { %>
      <a
        href="/admin/manage_perfumes?page=<%= i %>"
        class="btn btn-sm <%= currentPage === i ? 'btn-active btn-primary' : 'btn-outline' %>"
      >
        <%= i %>
      </a>
      <% } %>
    </div>
    <% } %>
  </div>
</div>

<!-- Modal Thêm Nước hoa -->
<dialog id="add_perfume_modal" class="modal">
  <div class="modal-box">
    <h3 class="modal-title">Thêm Nước hoa Mới</h3>

    <form
      action="/admin/perfumes"
      method="POST"
      enctype="multipart/form-data"
      class="form-grid"
    >
      <div class="form-group full">
        <label>Tên Nước hoa</label>
        <input type="text" name="perfumeName" required />
      </div>

      <div class="form-group">
        <label>Giá (VNĐ)</label>
        <input type="number" name="price" min="0" required />
      </div>

      <div class="form-group">
        <label>Dung tích (ml)</label>
        <input type="number" name="volume" min="1" required />
      </div>

      <div class="form-group">
        <label>Đối tượng</label>
        <select name="targetAudience" required>
          <option value="">Chọn</option>
          <option value="male">Nam</option>
          <option value="female">Nữ</option>
          <option value="unisex">Unisex</option>
        </select>
      </div>

      <div class="form-group">
        <label>Nồng độ</label>
        <select name="concentration" required>
          <option value="">Chọn</option>
          <option value="Extrait">Extrait</option>
          <option value="EDP">EDP</option>
          <option value="EDT">EDT</option>
          <option value="EDC">EDC</option>
        </select>
      </div>

      <div class="form-group">
        <label>Thương hiệu</label>
        <select name="brandId" required>
          <option value="">Chọn Thương hiệu</option>
          <% brands.forEach(brand => { %>
          <option value="<%= brand._id %>"><%= brand.brandName %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-group full">
        <label>Ảnh sản phẩm</label>
        <input type="file" name="image" accept="image/*" required />
      </div>

      <div class="form-group full">
        <label>Mô tả</label>
        <textarea name="description" required></textarea>
      </div>

      <div class="form-group full">
        <label>Thành phần</label>
        <textarea name="ingredients" required></textarea>
      </div>

      <div class="modal-actions">
        <button type="submit" class="btn btn-secondary">Thêm</button>
        <button
          type="button"
          class="btn btn-light"
          onclick="add_perfume_modal.close()"
        >
          Hủy
        </button>
      </div>
    </form>
  </div>
</dialog>

<!-- Modal Chỉnh sửa Nước hoa -->
<dialog id="edit_perfume_modal" class="modal">
  <div class="modal-box">
    <h3 class="modal-title warning">Chỉnh sửa Nước hoa</h3>

    <form
      id="editPerfumeForm"
      method="POST"
      enctype="multipart/form-data"
      class="form-grid"
    >
      <div class="form-group full">
        <label>Tên</label>
        <input type="text" id="editPerfumeName" name="perfumeName" required />
      </div>

      <div class="form-group">
        <label>Giá</label>
        <input type="number" id="editPrice" name="price" required />
      </div>

      <div class="form-group">
        <label>Dung tích</label>
        <input type="number" id="editVolume" name="volume" required />
      </div>

      <div class="form-group">
        <label>Đối tượng</label>
        <select id="editTargetAudience" name="targetAudience" required>
          <option value="male">Nam</option>
          <option value="female">Nữ</option>
          <option value="unisex">Unisex</option>
        </select>
      </div>

      <div class="form-group">
        <label>Nồng độ</label>
        <select id="editConcentration" name="concentration" required>
          <option value="Extrait">Extrait</option>
          <option value="EDP">EDP</option>
          <option value="EDT">EDT</option>
          <option value="EDC">EDC</option>
        </select>
      </div>

      <div class="form-group">
        <label>Thương hiệu</label>
        <select id="editBrandId" name="brandId">
          <% brands.forEach(brand => { %>
          <option value="<%= brand._id %>"><%= brand.brandName %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-group full">
        <label>Cập nhật Ảnh sản phẩm (Để trống nếu không đổi)</label>
        <input type="file" name="image" accept="image/*" />
        <span id="currentUriDisplay" class="text-muted text-xs">
          Ảnh cũ: <a href="" target="_blank"></a>
        </span>
      </div>

      <div class="form-group full">
        <label>Mô tả</label>
        <textarea id="editDescription" name="description"></textarea>
      </div>

      <div class="form-group full">
        <label>Thành phần</label>
        <textarea id="editIngredients" name="ingredients"></textarea>
      </div>

      <div class="modal-actions">
        <button type="submit" class="btn btn-warning">Cập nhật</button>
        <button
          type="button"
          class="btn btn-light"
          onclick="edit_perfume_modal.close()"
        >
          Hủy
        </button>
      </div>
    </form>
  </div>
</dialog>

<script>
  function editPerfume(perfumeJson) {
    const perfume = JSON.parse(perfumeJson.replace(/&quot;/g, '"'));
    const form = document.getElementById("editPerfumeForm");

    form.action = `/admin/perfumes/${perfume._id}?_method=PUT`;
    document.getElementById("editPerfumeName").value = perfume.perfumeName;
    document.getElementById("editPrice").value = perfume.price;
    document.getElementById("editVolume").value = perfume.volume;
    document.getElementById("editDescription").value = perfume.description;
    document.getElementById("editIngredients").value = perfume.ingredients;
    document.getElementById("editBrandId").value =
      perfume.brand._id || perfume.brand;
    document.getElementById("editTargetAudience").value =
      perfume.targetAudience;
    document.getElementById("editConcentration").value = perfume.concentration;

    const uriDisplay = document.querySelector("#currentUriDisplay a");
    uriDisplay.href = perfume.uri;
    uriDisplay.textContent = perfume.uri.split("/").pop();

    edit_perfume_modal.showModal();
  }
</script>

<%- include('../partials/footer') %>
