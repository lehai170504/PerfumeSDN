<%- include('partials/header', { title: perfume.perfumeName, user: loggedInUser,
pageCss: 'profile.css' }) %> <%- include('partials/navbar', { user: loggedInUser
}) %>

<div class="container">
  <% if (success && success.length > 0) { %>
  <div class="alert alert-success"><%= success[0] %></div>
  <% } %> <% if (error && error.length > 0) { %>
  <div class="alert alert-error"><%= error[0] %></div>
  <% } %>

  <div class="perfume-grid">
    <div class="sidebar">
      <img
        src="<%= perfume.uri %>"
        alt="<%= perfume.perfumeName %>"
        class="perfume-image"
      />

      <div class="info-box">
        <h3>Thông tin nhanh:</h3>
        <p>
          <strong>Giá:</strong>
          <span class="price"
            ><%= perfume.price.toLocaleString('vi-VN') %> VNĐ</span
          >
        </p>
        <p>
          <strong>Thương hiệu:</strong>
          <span class="badge brand"><%= perfume.brand.brandName %></span>
        </p>
        <p><strong>Dung tích:</strong> <%= perfume.volume %> ml</p>
        <p>
          <strong>Nồng độ:</strong>
          <% if (perfume.concentration === 'Extrait') { %>
          <span class="badge extrait">EXTRAIT</span>
          <% } else { %>
          <span class="badge normal"><%= perfume.concentration %></span>
          <% } %>
        </p>
        <p>
          <strong>Đối tượng:</strong>
          <span class="badge target"><%= perfume.targetAudience %></span>
        </p>
      </div>
    </div>

    <div class="main">
      <h1 class="perfume-name"><%= perfume.perfumeName %></h1>
      <p class="brand-line">Thương hiệu: <%= perfume.brand.brandName %></p>

      <section class="block">
        <h2>Mô tả</h2>
        <p><%= perfume.description %></p>
      </section>

      <section class="block">
        <h2>Thành phần</h2>
        <p><%= perfume.ingredients %></p>
        <p class="posted-date">
          Ngày đăng: <%= new Date(perfume.createdAt).toLocaleDateString('vi-VN')
          %>
        </p>
      </section>

      <section class="feedback">
        <h2>Đánh giá & Bình luận (<%= perfume.comments.length %>)</h2>

        <% if (loggedInUser) { const userComment = perfume.comments.find(c =>
        c.author && c.author._id.toString() === loggedInUser._id.toString()); %>
        <% if (userComment) { %>
        <div class="alert alert-warning">
          Bạn đã đánh giá sản phẩm này. Hãy sửa bình luận bên dưới.
        </div>
        <% } else { %>
        <form
          action="/perfumes/<%= perfume._id %>/comment"
          method="POST"
          class="comment-form"
        >
          <label>Đánh giá (1–3 điểm)</label>
          <div class="star-rating">
            <input
              type="radio"
              id="star3"
              name="rating"
              value="3"
              required
              checked
            />
            <label for="star3" title="Rất tốt - 3 sao">★</label>

            <input type="radio" id="star2" name="rating" value="2" required />
            <label for="star2" title="Tốt - 2 sao">★</label>

            <input type="radio" id="star1" name="rating" value="1" required />
            <label for="star1" title="Trung bình - 1 sao">★</label>
          </div>

          <label>Bình luận</label>
          <textarea name="content" required></textarea>

          <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
        </form>
        <% } %> <% } else { %>
        <div class="alert alert-info">
          Vui lòng <a href="/auth/login">đăng nhập</a> để gửi bình luận.
        </div>
        <% } %>

        <div class="comment-list">
          <% perfume.comments.forEach(comment => { const isAuthor = loggedInUser
          && comment.author && comment.author._id.toString() ===
          loggedInUser._id.toString(); %>
          <div class="comment <%= comment.rating > 2 ? 'good' : 'average' %>">
            <div class="comment-header">
              <span class="author"><%= comment.author.name %></span>
              <% if (isAuthor) { %><span class="you">(Bạn)</span><% } %>
              <span class="rating"><%= comment.rating %> điểm</span>
            </div>

            <p><%= comment.content %></p>
            <span class="date">
              Ngày: <%= new Date(comment.createdAt).toLocaleDateString('vi-VN')
              %>
            </span>

            <% if (isAuthor) { %>
            <div class="comment-actions">
              <button
                type="button"
                onclick="document.getElementById('editModal_<%= comment._id %>').showModal()"
              >
                Sửa
              </button>

              <form
                action="/perfumes/<%= perfume._id %>/comment/<%= comment._id %>?_method=DELETE"
                method="POST"
              >
                <button
                  type="submit"
                  onclick="return confirm('Bạn có chắc chắn muốn xóa không?')"
                >
                  Xóa
                </button>
              </form>
            </div>

            <dialog id="editModal_<%= comment._id %>" class="modal">
              <div class="modal-box">
                <h3>Chỉnh sửa bình luận</h3>

                <form
                  action="/perfumes/<%= perfume._id %>/comment/<%= comment._id %>?_method=PUT"
                  method="POST"
                >
                  <label>Đánh giá</label>
                  <div class="star-rating">
                    <input type="radio" id="edit_star3_<%= comment._id %>"
                    name="rating" value="3" <%= comment.rating == 3 ? 'checked'
                    : '' %> />
                    <label
                      for="edit_star3_<%= comment._id %>"
                      title="Rất tốt - 3 sao"
                      >★</label
                    >

                    <input type="radio" id="edit_star2_<%= comment._id %>"
                    name="rating" value="2" <%= comment.rating == 2 ? 'checked'
                    : '' %> />
                    <label
                      for="edit_star2_<%= comment._id %>"
                      title="Tốt - 2 sao"
                      >★</label
                    >

                    <input type="radio" id="edit_star1_<%= comment._id %>"
                    name="rating" value="1" <%= comment.rating == 1 ? 'checked'
                    : '' %> />
                    <label
                      for="edit_star1_<%= comment._id %>"
                      title="Trung bình - 1 sao"
                      >★</label
                    >
                  </div>

                  <label>Bình luận</label>
                  <textarea name="content"><%= comment.content %></textarea>

                  <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Lưu</button>
                    <button
                      type="button"
                      onclick="document.getElementById('editModal_<%= comment._id %>').close()"
                    >
                      Hủy
                    </button>
                  </div>
                </form>
              </div>
            </dialog>
            <% } %>
          </div>
          <% }) %>
        </div>
      </section>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
