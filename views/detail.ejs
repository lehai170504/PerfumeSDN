<%- include('partials/header', { title: perfume.perfumeName, user: loggedInUser
}) %> <%- include('partials/navbar', { user: loggedInUser }) %>

<div class="container mx-auto p-4">
  <!-- Alert messages -->
  <% if (messages && messages.length > 0) { %> <% messages.forEach(msg => { %>
  <div
    role="alert"
    class="alert <%= msg.type === 'success' ? 'alert-success' : 'alert-error' %> mb-6"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="stroke-current shrink-0 h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <span><%= msg.text %></span>
  </div>
  <% }) %> <% } %>

  <div
    class="grid grid-cols-1 lg:grid-cols-3 gap-10 bg-base-100 p-8 rounded-xl shadow-2xl"
  >
    <!-- Perfume Info Sidebar -->
    <div class="lg:col-span-1">
      <figure class="rounded-lg overflow-hidden mb-6 shadow-xl">
        <img
          src="<%= perfume.uri %>"
          alt="<%= perfume.perfumeName %>"
          class="w-full h-auto object-cover"
        />
      </figure>

      <div class="space-y-3 p-4 bg-base-200 rounded-lg">
        <h3 class="text-xl font-bold">Thông tin nhanh:</h3>

        <p>
          <strong>Giá:</strong>
          <span class="text-error font-extrabold text-2xl"
            ><%= perfume.price.toLocaleString('vi-VN') %> VNĐ</span
          >
        </p>
        <p>
          <strong>Thương hiệu:</strong>
          <span class="badge badge-primary"
            ><%= perfume.brand.brandName %></span
          >
        </p>
        <p><strong>Dung tích:</strong> <%= perfume.volume %> ml</p>
        <p>
          <strong>Nồng độ:</strong>
          <% if (perfume.concentration === 'Extrait') { %>
          <span class="badge badge-warning text-lg font-bold">EXTRAIT</span>
          <% } else { %>
          <span class="badge badge-secondary"
            ><%= perfume.concentration %></span
          >
          <% } %>
        </p>
        <p>
          <strong>Đối tượng:</strong>
          <span class="badge badge-info"><%= perfume.targetAudience %></span>
        </p>
      </div>
    </div>

    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-8">
      <!-- Perfume Header -->
      <div class="pb-4 border-b">
        <h1 class="text-5xl font-extrabold text-primary mb-2">
          <%= perfume.perfumeName %>
        </h1>
        <p class="text-xl text-gray-500">
          Thương hiệu: <%= perfume.brand.brandName %>
        </p>
      </div>

      <!-- Description -->
      <div>
        <h2 class="text-3xl font-bold mb-4 border-l-4 border-secondary pl-3">
          Mô tả
        </h2>
        <p class="text-lg leading-relaxed whitespace-pre-line">
          <%= perfume.description %>
        </p>
      </div>

      <!-- Ingredients -->
      <div>
        <h2 class="text-3xl font-bold mb-4 border-l-4 border-secondary pl-3">
          Thành phần
        </h2>
        <p class="text-lg leading-relaxed"><%= perfume.ingredients %></p>
        <p class="text-xs text-gray-400 mt-2">
          Ngày đăng: <%= new Date(perfume.createdAt).toLocaleDateString('vi-VN')
          %>
        </p>
      </div>

      <!-- Feedback Section -->
      <div id="feedback-section">
        <h2 class="text-3xl font-bold mb-6 border-l-4 border-primary pl-3">
          Đánh giá & Bình luận (<%= perfume.comments.length %>)
        </h2>

        <!-- Comment Form -->
        <% if (loggedInUser) { %> <% let userComment = null; if (loggedInUser) {
        userComment = perfume.comments.find(function(c) { return c.author &&
        c.author._id.toString() === loggedInUser._id.toString(); }); } %>
        <div class="card bg-base-200 shadow-lg p-6 mb-8">
          <h3 class="text-2xl font-semibold mb-4 text-primary">
            Gửi đánh giá của bạn
          </h3>
          <% if (userComment) { %>
          <div class="alert alert-warning">
            Bạn đã đánh giá sản phẩm này rồi. Vui lòng **Sửa** bình luận của bạn
            ngay bên dưới.
          </div>
          <% } else { %>
          <form
            action="/perfumes/<%= perfume._id %>/comment"
            method="POST"
            class="space-y-4"
          >
            <div class="form-control">
              <label class="label"
                ><span class="label-text">Đánh giá (1-3 điểm)</span></label
              >
              <input
                type="range"
                name="rating"
                min="1"
                max="3"
                value="3"
                class="range range-primary"
                step="1"
                required
              />
              <div class="w-full flex justify-between text-xs px-2">
                <span>1: Tệ</span>
                <span>2: Tốt</span>
                <span>3: Xuất sắc</span>
              </div>
            </div>
            <div class="form-control">
              <label class="label"
                ><span class="label-text">Bình luận</span></label
              >
              <textarea
                name="content"
                class="textarea textarea-bordered h-24"
                placeholder="Viết bình luận của bạn tại đây..."
                required
              ></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Gửi Đánh giá</button>
          </form>
          <% } %>
        </div>
        <% } else { %>
        <div class="alert alert-info shadow-lg">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            class="stroke-current flex-shrink-0 w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <span
            >Vui lòng
            <a href="/auth/login" class="font-bold link">đăng nhập</a> để gửi
            bình luận. Chỉ thành viên mới có thể phản hồi.</span
          >
        </div>
        <% } %>

        <!-- Comments List -->
        <div class="space-y-4 mt-6">
          <% perfume.comments.forEach(comment => { const isAuthor = loggedInUser
          && comment.author && comment.author._id.toString() ===
          loggedInUser._id.toString(); %>
          <div
            class="card bg-white shadow-md p-5 border-l-4 <%= comment.rating > 2 ? 'border-success' : 'border-info' %>"
          >
            <div class="flex justify-between items-start mb-2">
              <div>
                <span class="font-bold text-lg"
                  ><%= comment.author.name %></span
                >
                <% if (isAuthor) { %><span class="badge badge-error ml-2"
                  >Bạn</span
                ><% } %>
              </div>
              <div class="flex items-center">
                <div
                  class="badge badge-lg mr-4 <%= comment.rating > 2 ? 'badge-success' : 'badge-info' %>"
                >
                  <%= comment.rating %> Điểm
                </div>
                <% if (isAuthor) { %>
                <button
                  class="btn btn-xs btn-warning mr-2"
                  onclick="document.getElementById('editModal_<%= comment._id %>').showModal()"
                >
                  Sửa
                </button>
                <form
                  action="/perfumes/<%= perfume._id %>/comment/<%= comment._id %>?_method=DELETE"
                  method="POST"
                  onsubmit="return confirm('Bạn có chắc chắn muốn xóa bình luận này không?')"
                  style="display: inline"
                >
                  <button type="submit" class="btn btn-xs btn-error">
                    Xóa
                  </button>
                </form>
                <% } %>
              </div>
            </div>
            <p class="text-gray-700" id="comment-content-<%= comment._id %>">
              <%= comment.content %>
            </p>
            <span class="text-sm text-gray-500 mt-2 block"
              >Ngày: <%= new Date(comment.createdAt).toLocaleDateString('vi-VN')
              %></span
            >

            <% if (isAuthor) { %>
            <dialog id="editModal_<%= comment._id %>" class="modal">
              <div class="modal-box">
                <h3 class="font-bold text-lg text-primary">
                  Chỉnh sửa Bình luận
                </h3>
                <form
                  action="/perfumes/<%= perfume._id %>/comment/<%= comment._id %>?_method=PUT"
                  method="POST"
                  class="space-y-4 py-4"
                >
                  <div class="form-control">
                    <label class="label"
                      ><span class="label-text"
                        >Đánh giá (1-3 điểm)</span
                      ></label
                    >
                    <input
                      type="range"
                      name="rating"
                      min="1"
                      max="3"
                      value="<%= comment.rating %>"
                      class="range range-primary"
                      step="1"
                      required
                    />
                    <div class="w-full flex justify-between text-xs px-2">
                      <span>1: Tệ</span>
                      <span>2: Tốt</span>
                      <span>3: Xuất sắc</span>
                    </div>
                  </div>
                  <div class="form-control">
                    <label class="label"
                      ><span class="label-text">Bình luận</span></label
                    >
                    <textarea
                      name="content"
                      class="textarea textarea-bordered h-24"
                      required
                    >
<%= comment.content %></textarea
                    >
                  </div>
                  <div class="modal-action">
                    <button type="submit" class="btn btn-primary">
                      Lưu Thay đổi
                    </button>
                    <button
                      type="button"
                      class="btn"
                      onclick="document.getElementById('editModal_<%= comment._id %>').close()"
                    >
                      Hủy
                    </button>
                  </div>
                </form>
              </div>
              <form method="dialog" class="modal-backdrop">
                <button>close</button>
              </form>
            </dialog>
            <% } %> <% }) %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>
</div>
