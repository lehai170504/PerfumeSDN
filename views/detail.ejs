<%- include('partials/header', { title: perfume.perfumeName, user: loggedInUser
}) %> <%- include('partials/navbar', { user: loggedInUser }) %>

<div class="container mx-auto">
  <div
    class="grid grid-cols-1 lg:grid-cols-3 gap-10 bg-base-100 p-8 rounded-xl shadow-2xl"
  >
    <div class="lg:col-span-1">
      <figure class="rounded-lg overflow-hidden mb-6 shadow-xl">
        <img
          src="<%= perfume.uri %>"
          alt="<%= perfume.perfumeName %>"
          class="w-full h-auto object-cover"
        />
      </figure>
      <div class="space-y-3 p-4 bg-base-200 rounded-lg">
        <h3 class="text-xl font-bold">Thông tin nhanh:</h3>
        <p>
          <strong>Giá:</strong>
          <span class="text-error font-extrabold text-2xl"
            ><%= perfume.price.toLocaleString('vi-VN') %> VNĐ</span
          >
        </p>
        <p>
          <strong>Thương hiệu:</strong>
          <span class="badge badge-primary"
            ><%= perfume.brand.brandName %></span
          >
        </p>
        <p><strong>Dung tích:</strong> <%= perfume.volume %> ml</p>
        <p>
          <strong>Nồng độ:</strong>
          <% if (perfume.concentration === 'Extrait') { %>
          <span class="badge badge-warning text-lg font-bold">EXTRAIT</span>
          <% } else { %>
          <span class="badge badge-secondary"
            ><%= perfume.concentration %></span
          >
          <% } %>
        </p>
        <p>
          <strong>Đối tượng:</strong>
          <span class="badge badge-info"><%= perfume.targetAudience %></span>
        </p>
      </div>
    </div>

    <div class="lg:col-span-2 space-y-8">
      <div class="pb-4 border-b">
        <h1 class="text-5xl font-extrabold text-primary mb-2">
          <%= perfume.perfumeName %>
        </h1>
        <p class="text-xl text-gray-500">
          Thương hiệu: <%= perfume.brand.brandName %>
        </p>
      </div>

      <div>
        <h2 class="text-3xl font-bold mb-4 border-l-4 border-secondary pl-3">
          Mô tả
        </h2>
        <p class="text-lg leading-relaxed whitespace-pre-line">
          <%= perfume.description %>
        </p>
      </div>

      <div>
        <h2 class="text-3xl font-bold mb-4 border-l-4 border-secondary pl-3">
          Thành phần
        </h2>
        <p class="text-lg leading-relaxed"><%= perfume.ingredients %></p>
      </div>

      <div id="feedback-section">
        <h2 class="text-3xl font-bold mb-6 border-l-4 border-primary pl-3">
          Đánh giá & Bình luận (<%= perfume.comments.length %>)
        </h2>

        <% if (loggedInUser) { %>
        <div class="card bg-base-200 shadow-lg p-6 mb-8">
          <h3 class="text-2xl font-semibold mb-4 text-primary">
            Gửi đánh giá của bạn
          </h3>
          <% if (hasCommented) { %>
          <div class="alert alert-warning">
            Bạn đã đánh giá sản phẩm này rồi. Mỗi thành viên chỉ có thể đánh giá
            một lần[cite: 61, 85].
          </div>
          <% } else { %>
          <form
            action="/perfumes/<%= perfume._id %>/comment"
            method="POST"
            class="space-y-4"
          >
            <div class="form-control">
              <label class="label"
                ><span class="label-text"
                  >Đánh giá (1-3 điểm) [cite: 38]</span
                ></label
              >
              <input
                type="number"
                name="rating"
                min="1"
                max="3"
                class="range range-primary"
                step="1"
                required
              />
              <div class="w-full flex justify-between text-xs px-2">
                <span>1</span>
                <span>2</span>
                <span>3</span>
              </div>
            </div>

            <div class="form-control">
              <label class="label"
                ><span class="label-text">Bình luận</span></label
              >
              <textarea
                name="content"
                class="textarea textarea-bordered h-24"
                placeholder="Viết bình luận của bạn tại đây..."
                required
              ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Gửi Đánh giá</button>
          </form>
          <% } %>
        </div>
        <% } else { %>
        <div class="alert alert-info shadow-lg">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            class="stroke-current flex-shrink-0 w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <span
            >Vui lòng
            <a href="/auth/login" class="font-bold link">đăng nhập</a> để gửi
            bình luận. Chỉ thành viên mới có thể phản hồi.</span
          >
        </div>
        <% } %>

        <div class="space-y-4 mt-6">
          <% perfume.comments.forEach(comment => { %>
          <div
            class="card bg-white shadow-md p-5 border-l-4 <%= comment.rating > 2 ? 'border-success' : 'border-info' %>"
          >
            <div class="flex justify-between items-center mb-2">
              <span class="font-bold text-lg"
                ><%= comment.author.membername %></span
              >
              <div
                class="badge badge-lg <%= comment.rating > 2 ? 'badge-success' : 'badge-info' %>"
              >
                Rating: <%= comment.rating %>
              </div>
            </div>
            <p class="text-gray-700"><%= comment.content %></p>
            <span class="text-sm text-gray-500 mt-2 block"
              >Ngày: <%= new Date(comment.createdAt).toLocaleDateString()
              %></span
            >
          </div>
          <% }) %>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
